<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - AquaFlow Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’§</text></svg>">
    <meta name="theme-color" content="#0C2B4E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-remote-config-compat.js"></script>
</head>
<body class="app-page">
    
    <!-- Portal Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <button class="btn btn-back" onclick="window.location.href='index.html'">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="business-info">
                    <h1>Customer Portal</h1>
                </div>
            </div>
            <div class="header-right">
                <button class="btn btn-sm btn-outline" onclick="logoutCustomer()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Exit
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <!-- Login Section -->
        <section id="loginSection" class="auth-container" style="margin-top: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
            <div class="text-center mb-4">
                <div class="logo-icon" style="margin: 0 auto 1rem; width: 60px; height: 60px; font-size: 1.5rem;">
                    <i class="fas fa-user-circle"></i>
                </div>
                <h3>Secure Login</h3>
                <p class="text-muted" id="loginSubtext">Enter your mobile number to receive a One-Time Password (OTP).</p>
            </div>
            
            <!-- Step 1: Phone Number -->
            <form id="phoneForm" onsubmit="requestOtp(event)">
                <div class="form-group">
                    <label>Phone Number</label>
                    <div class="input-group">
                        <i class="fas fa-phone" style="position: absolute; left: 15px; top: 45px; color: var(--primary-light);"></i>
                        <!-- Removed fixed +91 span to allow flexibility, user enters full number -->
                        <input type="tel" id="portalPhone" class="form-input" style="padding-left: 40px;" placeholder="e.g. 9876543210" maxlength="10" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-block" id="getOtpBtn">
                    Get OTP <i class="fas fa-arrow-right"></i>
                </button>
            </form>

            <!-- Step 2: OTP Entry (Hidden initially) -->
            <form id="otpForm" class="hidden" onsubmit="verifyOtp(event)">
                <div class="form-group">
                    <label>Enter Verification Code</label>
                    <div class="input-group">
                        <i class="fas fa-key" style="position: absolute; left: 15px; top: 45px; color: var(--primary-light);"></i>
                        <input type="text" id="otpInput" class="form-input" style="padding-left: 40px; letter-spacing: 5px; font-weight: bold; font-size: 1.2rem; text-align: center;" placeholder="XXXX" maxlength="4" required>
                    </div>
                    <div style="text-align: right; margin-top: 10px;">
                        <span id="timer" class="text-muted" style="font-size: 0.85rem;">Resend in 30s</span>
                        <a href="#" id="resendLink" onclick="resendOtp()" style="font-size: 0.85rem; color: var(--primary); display: none;">Resend OTP</a>
                    </div>
                </div>
                <button type="submit" class="btn btn-success btn-block" id="verifyBtn">
                    Verify & Login <i class="fas fa-check"></i>
                </button>
                <button type="button" class="btn btn-text btn-block" onclick="resetLogin()" style="margin-top: 10px;">
                    Change Phone Number
                </button>
            </form>

        </section>

        <!-- Loading State -->
        <div id="portalLoader" class="loading-overlay hidden">
            <div class="loader-container">
                <div class="loader"></div>
                <p id="loaderText">Fetching your records...</p>
            </div>
        </div>

        <!-- Dashboard Section (Hidden by default) -->
        <section id="dashboardSection" class="hidden">
            
            <!-- Supplier Info Card -->
            <div class="stat-card" style="background: var(--gradient-primary); color: white; margin-bottom: 1.5rem;">
                <div class="stat-content">
                    <div style="font-size: 0.9rem; opacity: 0.9;">Serving Water Plant</div>
                    <h2 id="supplierName" style="font-size: 1.5rem; margin: 5px 0;">-</h2>
                    <div id="supplierPhone" style="font-size: 0.9rem; opacity: 0.9;"> <i class="fas fa-phone"></i> -</div>
                </div>
                <div class="stat-icon" style="background: rgba(255,255,255,0.2);">
                    <i class="fas fa-building"></i>
                </div>
            </div>

            <!-- Customer Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-number" id="totalDue" style="color: var(--danger);">â‚¹0</div>
                        <div class="stat-label">Total Outstanding</div>
                    </div>
                    <div class="stat-icon" style="background: var(--danger);">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-content">
                        <div class="stat-number" id="lastDelivery">-</div>
                        <div class="stat-label">Last Delivery</div>
                    </div>
                    <div class="stat-icon" style="background: var(--success);">
                        <i class="fas fa-truck"></i>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="auth-tabs" style="margin-bottom: 1rem;">
                <button class="tab-btn active" onclick="switchTab('deliveries')">
                    <i class="fas fa-truck"></i> Deliveries
                </button>
                <button class="tab-btn" onclick="switchTab('payments')">
                    <i class="fas fa-rupee-sign"></i> Payments & Bills
                </button>
            </div>

            <!-- Deliveries View -->
            <div id="deliveriesTab" class="portal-tab-content">
                <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">Delivery History</h3>
                <div id="deliveriesList">
                    <!-- Loaded via JS -->
                </div>
            </div>

            <!-- Payments View -->
            <div id="paymentsTab" class="portal-tab-content hidden">
                <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">Payment History</h3>
                <div class="payment-summary-card mb-4" style="background: var(--gray-50); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success);">
                    <h4 style="margin-bottom: 0.5rem;">Payment Summary</h4>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Billed Value:</span>
                        <strong id="summaryTotalBilled">â‚¹0</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total Paid:</span>
                        <strong id="summaryTotalPaid" class="text-success">â‚¹0</strong>
                    </div>
                </div>
                <div id="paymentsList">
                    <!-- Loaded via JS -->
                </div>
            </div>

        </section>
    </main>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loader = document.getElementById('portalLoader');
        const logoutBtn = document.getElementById('logoutBtn');
        const phoneForm = document.getElementById('phoneForm');
        const otpForm = document.getElementById('otpForm');
        const loginSubtext = document.getElementById('loginSubtext');

        // State
        let currentBusinessId = null;
        let currentCustomerId = null;
        let customerData = null;
        
        // Simulation Auth State
        let generatedOtp = null;
        let pendingPhone = null;

        // Check if previously logged in via local storage session
        document.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('portalSession'));
            if (session && session.phone && session.expiry > Date.now()) {
                console.log("Session valid for:", session.phone);
                fetchCustomerData(session.phone);
            } else {
                localStorage.removeItem('portalSession'); // Clear expired session
            }
        });

        // --- Simulated OTP Logic (Free & Simple) ---

        async function requestOtp(e) {
            e.preventDefault();
            const phoneInput = document.getElementById('portalPhone').value.trim();
            const getOtpBtn = document.getElementById('getOtpBtn');
            
            if(phoneInput.length !== 10) {
                alert("Please enter a valid 10-digit phone number");
                return;
            }

            // Disable button
            getOtpBtn.disabled = true;
            getOtpBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Checking...';

            try {
                // 1. SECURITY CHECK: Verify user exists in Database first
                // This ensures random people cannot just generate OTPs
                const customerSnapshot = await db.collectionGroup('customers')
                    .where('phone', '==', phoneInput)
                    .limit(1)
                    .get();

                if (customerSnapshot.empty) {
                    alert('No account found with this phone number. Please contact your water supplier to register.');
                    getOtpBtn.disabled = false;
                    getOtpBtn.innerHTML = 'Get OTP <i class="fas fa-arrow-right"></i>';
                    return;
                }

                // 2. Generate Random 4-digit OTP
                pendingPhone = phoneInput;
                generatedOtp = Math.floor(1000 + Math.random() * 9000).toString();
                
                // 3. Simulate Network Delay & Switch UI
                setTimeout(() => {
                    // Switch UI
                    phoneForm.classList.add('hidden');
                    otpForm.classList.remove('hidden');
                    loginSubtext.textContent = `OTP sent to ${phoneInput}`;
                    
                    // 4. SHOW OTP IN ALERT (Simulation)
                    alert(`[DEMO SMS]\n\nYour Verification Code is: ${generatedOtp}\n\n(In a real app, this would come via SMS)`);
                    
                    startTimer();
                    
                    getOtpBtn.disabled = false;
                    getOtpBtn.innerHTML = 'Get OTP <i class="fas fa-arrow-right"></i>';
                }, 1000);

            } catch (error) {
                console.error("Error:", error);
                alert("Connection error. Please try again.");
                getOtpBtn.disabled = false;
                getOtpBtn.innerHTML = 'Get OTP <i class="fas fa-arrow-right"></i>';
            }
        }

        function verifyOtp(e) {
            e.preventDefault();
            const code = document.getElementById('otpInput').value.trim();
            const verifyBtn = document.getElementById('verifyBtn');

            if (code.length !== 4) {
                alert("Please enter the 4-digit code.");
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Verifying...';

            // Simulate server verification
            setTimeout(() => {
                if (code === generatedOtp) {
                    // Success
                    loginSubtext.textContent = "Verified! Logging in...";
                    
                    // Create Session
                    const sessionData = {
                        phone: pendingPhone,
                        expiry: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
                    };
                    localStorage.setItem('portalSession', JSON.stringify(sessionData));
                    
                    // Load Data
                    fetchCustomerData(pendingPhone);
                } else {
                    alert("Incorrect code. Please try again.");
                    document.getElementById('otpInput').value = '';
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = 'Verify & Login <i class="fas fa-check"></i>';
                }
            }, 800);
        }

        function resendOtp() {
            // Re-generate and show alert again
            generatedOtp = Math.floor(1000 + Math.random() * 9000).toString();
            alert(`[DEMO SMS]\n\nYour NEW Verification Code is: ${generatedOtp}`);
            startTimer();
        }

        function resetLogin() {
            phoneForm.classList.remove('hidden');
            otpForm.classList.add('hidden');
            document.getElementById('otpInput').value = '';
            loginSubtext.textContent = "Enter your mobile number to receive a One-Time Password (OTP).";
            pendingPhone = null;
            generatedOtp = null;
        }

        function startTimer() {
            let timeLeft = 30;
            const timerEl = document.getElementById('timer');
            const resendLink = document.getElementById('resendLink');
            
            timerEl.style.display = 'inline';
            resendLink.style.display = 'none';
            
            const interval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `Resend in ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    timerEl.style.display = 'none';
                    resendLink.style.display = 'inline';
                }
            }, 1000);
        }

        // --- Data Fetching Logic ---

        async function fetchCustomerData(phone) {
            showLoader("Loading your dashboard...");
            
            try {
                // 1. Find Customer Document
                // We use collectionGroup to find the customer across all businesses
                const customerSnapshot = await db.collectionGroup('customers')
                    .where('phone', '==', phone)
                    .limit(1)
                    .get();

                if (customerSnapshot.empty) {
                    hideLoader();
                    resetLogin();
                    localStorage.removeItem('portalSession');
                    alert('Account not found.'); 
                    return;
                }

                const customerDoc = customerSnapshot.docs[0];
                customerData = customerDoc.data();
                currentCustomerId = customerDoc.id;
                
                // 2. Identify Business Owner (Parent of the customer collection)
                // Path structure: artifacts/{appId}/users/{userId}/customers/{customerId}
                const businessDocRef = customerDoc.ref.parent.parent;
                currentBusinessId = businessDocRef.id;

                // 3. Fetch All Required Data in Parallel
                await Promise.all([
                    fetchBusinessDetails(businessDocRef),
                    fetchDeliveries(businessDocRef),
                    fetchPayments(businessDocRef)
                ]);

                // 4. Update UI
                updateUI();
                
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                logoutBtn.style.display = 'block';

            } catch (error) {
                console.error("Error fetching data:", error);
                localStorage.removeItem('portalSession');
                loginSection.classList.remove('hidden');
                dashboardSection.classList.add('hidden');
                alert("An error occurred while fetching your data. Please try again.");
            } finally {
                hideLoader();
            }
        }

        async function fetchBusinessDetails(businessDocRef) {
            const doc = await businessDocRef.get();
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('supplierName').textContent = data.businessName || 'Water Service Provider';
                document.getElementById('supplierPhone').innerHTML = `<i class="fas fa-phone"></i> ${data.businessPhone || 'Contact Provider'}`;
            }
        }

        let allDeliveries = [];
        let allPayments = [];

        async function fetchDeliveries(businessDocRef) {
            const snapshot = await businessDocRef.collection('deliveries')
                .where('customerId', '==', currentCustomerId)
                .orderBy('timestamp', 'desc')
                .limit(100)
                .get();
            
            allDeliveries = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                date: doc.data().timestamp ? new Date(doc.data().timestamp.seconds * 1000) : new Date()
            }));
        }

        async function fetchPayments(businessDocRef) {
            const snapshot = await businessDocRef.collection('payments')
                .where('customerId', '==', currentCustomerId)
                .orderBy('paidAt', 'desc')
                .limit(50)
                .get();
            
            allPayments = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                date: doc.data().paidAt ? new Date(doc.data().paidAt.seconds * 1000) : new Date()
            }));
        }

        function updateUI() {
            // Calculate Stats
            const pricePerCan = customerData.pricePerCan || 20; // Fallback price if not set
            let totalCost = 0;
            
            // Deliveries List
            const deliveriesList = document.getElementById('deliveriesList');
            if (allDeliveries.length === 0) {
                deliveriesList.innerHTML = '<div class="empty-state"><p>No deliveries found.</p></div>';
                document.getElementById('lastDelivery').textContent = 'None';
            } else {
                // Set Last Delivery
                const last = allDeliveries[0];
                document.getElementById('lastDelivery').textContent = `${last.quantity} Can(s) on ${last.date.toLocaleDateString()}`;

                deliveriesList.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>Date</th><th>Qty</th><th>Cost</th></tr></thead>
                            <tbody>
                                ${allDeliveries.map(d => {
                                    const cost = (d.quantity || 1) * pricePerCan;
                                    totalCost += cost;
                                    return `
                                    <tr>
                                        <td>${d.date.toLocaleDateString()} <br><small class="text-muted">${d.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small></td>
                                        <td><strong>${d.quantity}</strong></td>
                                        <td>â‚¹${cost}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            // Calculate Payments
            let totalPaid = 0;
            const paymentsList = document.getElementById('paymentsList');
            
            if (allPayments.length === 0) {
                paymentsList.innerHTML = '<div class="empty-state"><p>No payments recorded.</p></div>';
            } else {
                paymentsList.innerHTML = `
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead><tr><th>Date</th><th>Amount</th><th>Method</th></tr></thead>
                            <tbody>
                                ${allPayments.map(p => {
                                    totalPaid += (p.amount || 0);
                                    return `
                                    <tr>
                                        <td>${p.date.toLocaleDateString()}</td>
                                        <td class="text-success fw-bold">â‚¹${p.amount}</td>
                                        <td>${p.method || 'Cash'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            // Update Summary Stats
            const outstanding = totalCost - totalPaid;
            const totalDueEl = document.getElementById('totalDue');
            
            totalDueEl.textContent = `â‚¹${outstanding}`;
            totalDueEl.style.color = outstanding > 0 ? 'var(--danger)' : 'var(--success)';
            if (outstanding <= 0) totalDueEl.textContent = "Paid âœ“";

            document.getElementById('summaryTotalBilled').textContent = `â‚¹${totalCost}`;
            document.getElementById('summaryTotalPaid').textContent = `â‚¹${totalPaid}`;
        }

        // Tab Switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.portal-tab-content').forEach(content => content.classList.add('hidden'));
            
            // Find active tab button (approximate match)
            const buttons = document.querySelectorAll('.tab-btn');
            if (tabName === 'deliveries') buttons[0].classList.add('active');
            if (tabName === 'payments') buttons[1].classList.add('active');

            document.getElementById(tabName + 'Tab').classList.remove('hidden');
        };

        window.logoutCustomer = function() {
            localStorage.removeItem('portalSession');
            location.reload();
        };

        function showLoader(text = "Loading...") { 
            document.getElementById('loaderText').textContent = text;
            loader.classList.remove('hidden'); 
        }
        function hideLoader() { loader.classList.add('hidden'); }

    </script>
</body>
</html>
